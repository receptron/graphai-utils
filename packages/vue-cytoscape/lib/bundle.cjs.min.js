"use strict";var e=require("vue"),t=require("graphai"),a=require("cytoscape"),o=require("cytoscape-klay");a.use(o);const s="klay",n="#88f",r=[{selector:"node",style:{"background-color":"data(color)",label:"data(id)",shape:e=>e.data("isStatic")?"rectangle":"roundrectangle",width:e=>{return null==(t=e.data("id"))?"50px":Math.max(50,8*t.length)+"px";var t},color:"#fff",height:"30px","text-valign":"center","text-halign":"center","font-size":"12px"}},{selector:"edge",style:{width:3,"line-color":"#888","target-arrow-color":"#888","target-arrow-shape":"triangle","curve-style":"straight","text-background-color":"#ffffff","text-background-opacity":.8,"text-background-shape":"rectangle","font-size":"10px"}},{selector:"edge[label]",style:{label:"data(label)"}},{selector:"edge[isUpdate]",style:{color:"#ddd","line-color":"#ddd","line-style":"dashed","curve-style":"unbundled-bezier","target-arrow-color":"#ddd"}},{selector:"edge[isResult]",style:{color:"#d00","line-color":"#d00","line-style":"dotted","curve-style":"unbundled-bezier","target-arrow-color":"#d00"}}],l={[t.NodeState.Waiting]:"#888",[t.NodeState.Completed]:"#000",[t.NodeState.Executing]:"#0f0","executing-server":"#FFC0CB",[t.NodeState.Queued]:"#ff0",[t.NodeState.Injected]:"#00f",[t.NodeState.TimedOut]:"#f0f",[t.NodeState.Failed]:"#f00",[t.NodeState.Skipped]:"#0ff"},d=e=>{const t=e.slice(1).split(".");return{source:t.shift()||"",label:t.length?t.join("."):void 0}},c=e=>{if(Array.isArray(e))return e.map((e=>c(e))).flat();if(t.isObject(e))return Object.values(e).map((e=>c(e))).flat();if("string"==typeof e){const t=Array.from(e.matchAll(/\${(:[^}]+)}/g)).map((e=>e[1]));if(t.length>0)return c(t)}return e},i=e=>{const a={nodes:[],edges:[],map:{}},o=e=>{a.edges.push({data:e})},s=e=>{Object.keys(e.nodes||{}).forEach((r=>{const i=e.nodes[r],u=((e,a)=>{const o="value"in e;return{data:{id:a,color:o?n:l[t.NodeState.Waiting],isStatic:o}}})(i,r);if(a.nodes.push(u),a.map[r]=u,((e,t)=>{const a=[];if("inputs"in e&&c(e.inputs).forEach((e=>{if(":"===e[0]){const{source:o,label:s}=d(e);a.push({data:{source:o,target:t,label:s}})}})),"update"in e&&e.update){const{source:o,label:s}=d(e.update);a.push({data:{source:o,target:t,isUpdate:!0,label:s}})}return a})(i,r).forEach((e=>{a.edges.push(e)})),"agent"in i&&"nestedAgent"===i.agent){const e="string"==typeof i.graph?JSON.parse(i.graph):{...i.graph},t=Object.keys(e.nodes).filter((t=>"value"in e.nodes[t])).reduce(((t,a)=>{const{source:o}=d(e.nodes[a].value);return t[o]||(t[o]=[]),t[o].push(a),t}),{});Object.keys(i.inputs).forEach((a=>{e.nodes[a]={value:"dummy"};const{source:s}=d(i.inputs[a]);o({source:r,target:a,label:s}),t[a]&&t[a].forEach((e=>{o({source:r,target:e,label:a})}))})),s(e),Object.keys(e.nodes).forEach((t=>{const a=e.nodes[t];"agent"in a&&a.isResult&&o({source:t,target:r,label:"result",isResult:!0})}))}}))};return s(e),{elements:a}};exports.dataSourceNodeIds=e=>e.filter((e=>e.nodeId)).map((e=>e.nodeId)),exports.inputs2dataSources=c,exports.useCytoscape=o=>{let d=null;const c=e.ref(i(o.value??{nodes:{}})),u=e.ref(),p=e.ref(!0),g=async()=>{if(d){d.elements().remove(),d.add(c.value.elements);const e=c.value.elements.nodes.reduce(((e,t)=>t.position?"preset":e),s);console.log("layout",e),d.layout({name:e}).run(),d.fit(),e===s&&(await t.sleep(400),f())}},f=()=>{console.log("storePositions"),d&&d.nodes().forEach((e=>{const t=e.id(),a=e.position();c.value.elements.map[t].position=a}))};e.watch(c,(()=>{console.log("updated"),g()})),e.watch(o,(()=>{c.value=i(o.value)})),e.onMounted((()=>{(()=>{try{d=a({container:u.value,style:r,layout:{name:s}}),d.on("mouseup",f),d.on("touchend",f)}catch(e){console.error(e)}})(),g()}));return e.watch(p,(e=>{d&&d.zoomingEnabled(e)})),{cytoscapeRef:u,updateCytoscape:async(e,a)=>{[t.NodeState.Completed,t.NodeState.Waiting].includes(a)&&await t.sleep(100);const s=c.value.elements;s.map[e].data.color=l[a];const r=o.value,d=(r?.nodes??{})[e]??[];"agent"in d&&a===t.NodeState.Queued&&(d.priority??0)>0?s.map[e].data.color="#f80":"value"in d&&a===t.NodeState.Waiting&&(s.map[e].data.color=n),c.value={elements:s},a===t.NodeState.Injected&&(await t.sleep(100),s.map[e].data.color=n,c.value={elements:s})},resetCytoscape:()=>{const e=c.value.elements;Object.keys(e.map).forEach((a=>{const s=o.value.nodes[a];e.map[a].data.color="value"in s?n:l[t.NodeState.Waiting]})),c.value={elements:e}},layoutCytoscape:e=>{if(d){const t=d.nodes().map((e=>({id:e.id(),position:e.position()})));console.log(JSON.stringify(t)),localStorage.setItem("layoutData-"+e,JSON.stringify(t))}},loadLayout:e=>{const t=localStorage.getItem("layoutData-"+e);if(t){JSON.parse(t).forEach((e=>{if(d){const t=d.getElementById(e.id);t&&t.position(e.position)}}))}},zoomingEnabled:p}};
//# sourceMappingURL=bundle.cjs.min.js.map
