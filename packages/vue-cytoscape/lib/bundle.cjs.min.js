"use strict";var e=require("vue"),t=require("graphai"),a=require("cytoscape"),o=require("cytoscape-klay");a.use(o);const l="klay",s="#88f",n=[{selector:"node",style:{"background-color":"data(color)",label:"data(id)",shape:e=>e.data("isStatic")?"rectangle":"roundrectangle",width:e=>{return null==(t=e.data("id"))?"50px":Math.max(50,8*t.length)+"px";var t},color:"#fff",height:"30px","text-valign":"center","text-halign":"center","font-size":"12px"}},{selector:"edge",style:{width:3,"line-color":"#888","target-arrow-color":"#888","target-arrow-shape":"triangle","curve-style":"straight","text-background-color":"#ffffff","text-background-opacity":.8,"text-background-shape":"rectangle","font-size":"10px"}},{selector:"edge[label]",style:{label:"data(label)"}},{selector:"edge[isUpdate]",style:{color:"#ddd","line-color":"#ddd","line-style":"dashed","curve-style":"unbundled-bezier","target-arrow-color":"#ddd"}}],r={[t.NodeState.Waiting]:"#888",[t.NodeState.Completed]:"#000",[t.NodeState.Executing]:"#0f0","executing-server":"#FFC0CB",[t.NodeState.Queued]:"#ff0",[t.NodeState.Injected]:"#00f",[t.NodeState.TimedOut]:"#f0f",[t.NodeState.Failed]:"#f00",[t.NodeState.Skipped]:"#0ff"},d=e=>{const t=e.slice(1).split(".");return{source:t.shift()||"",label:t.length?t.join("."):void 0}},i=e=>{if(Array.isArray(e))return e.map((e=>i(e))).flat();if(t.isObject(e))return Object.values(e).map((e=>i(e))).flat();if("string"==typeof e){const t=Array.from(e.matchAll(/\${(:[^}]+)}/g)).map((e=>e[1]));if(t.length>0)return i(t)}return e},c=e=>({elements:Object.keys(e.nodes||{}).reduce(((a,o)=>{const l=e.nodes[o],n="value"in l,c={data:{id:o,color:n?s:r[t.NodeState.Waiting],isStatic:n}};if(a.nodes.push(c),a.map[o]=c,"inputs"in l&&i(l.inputs).forEach((e=>{if(":"===e[0]){const{source:t,label:l}=d(e);a.edges.push({data:{source:t,target:o,label:l}})}})),"update"in l&&l.update){const{source:e,label:t}=d(l.update);a.edges.push({data:{source:e,target:o,isUpdate:!0,label:t}})}return a}),{nodes:[],edges:[],map:{}})});exports.dataSourceNodeIds=e=>e.filter((e=>e.nodeId)).map((e=>e.nodeId)),exports.inputs2dataSources=i,exports.useCytoscape=o=>{let d=null;const i=e.ref(c(o.value??{nodes:{}})),u=e.ref(),p=e.ref(!0),f=async()=>{if(d){d.elements().remove(),d.add(i.value.elements);const e=i.value.elements.nodes.reduce(((e,t)=>t.position?"preset":e),l);console.log("layout",e),d.layout({name:e}).run(),d.fit(),e===l&&(await t.sleep(400),g())}},g=()=>{console.log("storePositions"),d&&d.nodes().forEach((e=>{const t=e.id(),a=e.position();i.value.elements.map[t].position=a}))};e.watch(i,(()=>{console.log("updated"),f()})),e.watch(o,(()=>{i.value=c(o.value)})),e.onMounted((()=>{(()=>{try{d=a({container:u.value,style:n,layout:{name:l}}),d.on("mouseup",g),d.on("touchend",g)}catch(e){console.error(e)}})(),f()}));return e.watch(p,(e=>{d&&d.zoomingEnabled(e)})),{cytoscapeRef:u,updateCytoscape:async(e,a)=>{[t.NodeState.Completed,t.NodeState.Waiting].includes(a)&&await t.sleep(100);const l=i.value.elements;l.map[e].data.color=r[a];const n=o.value,d=(n?.nodes??{})[e]??[];"agent"in d&&a===t.NodeState.Queued&&(d.priority??0)>0?l.map[e].data.color="#f80":"value"in d&&a===t.NodeState.Waiting&&(l.map[e].data.color=s),i.value={elements:l},a===t.NodeState.Injected&&(await t.sleep(100),l.map[e].data.color=s,i.value={elements:l})},resetCytoscape:()=>{const e=i.value.elements;Object.keys(e.map).forEach((a=>{const l=o.value.nodes[a];e.map[a].data.color="value"in l?s:r[t.NodeState.Waiting]})),i.value={elements:e}},layoutCytoscape:e=>{if(d){const t=d.nodes().map((e=>({id:e.id(),position:e.position()})));console.log(JSON.stringify(t)),localStorage.setItem("layoutData-"+e,JSON.stringify(t))}},loadLayout:e=>{const t=localStorage.getItem("layoutData-"+e);if(t){JSON.parse(t).forEach((e=>{if(d){const t=d.getElementById(e.id);t&&t.position(e.position)}}))}},zoomingEnabled:p}};
//# sourceMappingURL=bundle.cjs.min.js.map
