import{ref as e,watch as t,onMounted as a}from"vue";import{NodeState as o,isObject as l,sleep as n}from"graphai";import s from"cytoscape";import r from"cytoscape-klay";s.use(r);const i="klay",c="#88f",d=[{selector:"node",style:{"background-color":"data(color)",label:"data(id)",shape:e=>e.data("isStatic")?"rectangle":"roundrectangle",width:e=>{return null==(t=e.data("id"))?"50px":Math.max(50,8*t.length)+"px";var t},color:"#fff",height:"30px","text-valign":"center","text-halign":"center","font-size":"12px"}},{selector:"edge",style:{width:3,"line-color":"#888","target-arrow-color":"#888","target-arrow-shape":"triangle","curve-style":"straight","text-background-color":"#ffffff","text-background-opacity":.8,"text-background-shape":"rectangle","font-size":"10px"}},{selector:"edge[label]",style:{label:"data(label)"}},{selector:"edge[isUpdate]",style:{color:"#ddd","line-color":"#ddd","line-style":"dashed","curve-style":"unbundled-bezier","target-arrow-color":"#ddd"}}],u={[o.Waiting]:"#888",[o.Completed]:"#000",[o.Executing]:"#0f0","executing-server":"#FFC0CB",[o.Queued]:"#ff0",[o.Injected]:"#00f",[o.TimedOut]:"#f0f",[o.Failed]:"#f00",[o.Skipped]:"#0ff"},p=e=>{const t=e.slice(1).split(".");return{source:t.shift()||"",label:t.length?t.join("."):void 0}},f=e=>{if(Array.isArray(e))return e.map((e=>f(e))).flat();if(l(e))return Object.values(e).map((e=>f(e))).flat();if("string"==typeof e){const t=Array.from(e.matchAll(/\${(:[^}]+)}/g)).map((e=>e[1]));if(t.length>0)return f(t)}return e},g=e=>e.filter((e=>e.nodeId)).map((e=>e.nodeId)),m=e=>({elements:Object.keys(e.nodes||{}).reduce(((t,a)=>{const l=e.nodes[a],n="value"in l,s={data:{id:a,color:n?c:u[o.Waiting],isStatic:n}};if(t.nodes.push(s),t.map[a]=s,"inputs"in l&&f(l.inputs).forEach((e=>{if(":"===e[0]){const{source:o,label:l}=p(e);t.edges.push({data:{source:o,target:a,label:l}})}})),"update"in l&&l.update){const{source:e,label:o}=p(l.update);t.edges.push({data:{source:e,target:a,isUpdate:!0,label:o}})}return t}),{nodes:[],edges:[],map:{}})}),y=l=>{let r=null;const p=e(m(l.value??{nodes:{}})),f=e(),g=e(!0),y=async()=>{if(r){r.elements().remove(),r.add(p.value.elements);const e=p.value.elements.nodes.reduce(((e,t)=>t.position?"preset":e),i);console.log("layout",e),r.layout({name:e}).run(),r.fit(),e===i&&(await n(400),h())}},h=()=>{console.log("storePositions"),r&&r.nodes().forEach((e=>{const t=e.id(),a=e.position();p.value.elements.map[t].position=a}))};t(p,(()=>{console.log("updated"),y()})),t(l,(()=>{p.value=m(l.value)})),a((()=>{(()=>{try{r=s({container:f.value,style:d,layout:{name:i}}),r.on("mouseup",h),r.on("touchend",h)}catch(e){console.error(e)}})(),y()}));return t(g,(e=>{r&&r.zoomingEnabled(e)})),{cytoscapeRef:f,updateCytoscape:async(e,t)=>{[o.Completed,o.Waiting].includes(t)&&await n(100);const a=p.value.elements;a.map[e].data.color=u[t];const s=l.value,r=(s?.nodes??{})[e]??[];"agent"in r&&t===o.Queued&&(r.priority??0)>0?a.map[e].data.color="#f80":"value"in r&&t===o.Waiting&&(a.map[e].data.color=c),p.value={elements:a},t===o.Injected&&(await n(100),a.map[e].data.color=c,p.value={elements:a})},resetCytoscape:()=>{const e=p.value.elements;Object.keys(e.map).forEach((t=>{const a=l.value.nodes[t];e.map[t].data.color="value"in a?c:u[o.Waiting]})),p.value={elements:e}},layoutCytoscape:e=>{if(r){const t=r.nodes().map((e=>({id:e.id(),position:e.position()})));console.log(JSON.stringify(t)),localStorage.setItem("layoutData-"+e,JSON.stringify(t))}},loadLayout:e=>{const t=localStorage.getItem("layoutData-"+e);if(t){JSON.parse(t).forEach((e=>{if(r){const t=r.getElementById(e.id);t&&t.position(e.position)}}))}},zoomingEnabled:g}};export{g as dataSourceNodeIds,f as inputs2dataSources,y as useCytoscape};
//# sourceMappingURL=bundle.esm.min.js.map
