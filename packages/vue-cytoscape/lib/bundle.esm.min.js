import{ref as e,watch as t,onMounted as o}from"vue";import{NodeState as a,isObject as n,sleep as s}from"graphai";import l from"cytoscape";import r from"cytoscape-klay";l.use(r);const c="klay",i="#88f",d=[{selector:"node",style:{"background-color":"data(color)",label:"data(id)",shape:e=>e.data("isStatic")?"rectangle":"roundrectangle",width:e=>{return null==(t=e.data("id"))?"50px":Math.max(50,8*t.length)+"px";var t},color:"#fff",height:"30px","text-valign":"center","text-halign":"center","font-size":"12px"}},{selector:"edge",style:{width:3,"line-color":"#888","target-arrow-color":"#888","target-arrow-shape":"triangle","curve-style":"straight","text-background-color":"#ffffff","text-background-opacity":.8,"text-background-shape":"rectangle","font-size":"10px"}},{selector:"edge[label]",style:{label:"data(label)"}},{selector:"edge[isUpdate]",style:{color:"#ddd","line-color":"#ddd","line-style":"dashed","curve-style":"unbundled-bezier","target-arrow-color":"#ddd"}},{selector:"edge[isResult]",style:{color:"#d00","line-color":"#d00","line-style":"dotted","curve-style":"unbundled-bezier","target-arrow-color":"#d00"}}],u={[a.Waiting]:"#888",[a.Completed]:"#000",[a.Executing]:"#0f0","executing-server":"#FFC0CB",[a.Queued]:"#ff0",[a.Injected]:"#00f",[a.TimedOut]:"#f0f",[a.Failed]:"#f00",[a.Skipped]:"#0ff"},p=e=>{const t=e.slice(1).split(".");return{source:t.shift()||"",label:t.length?t.join("."):void 0}},g=e=>{if(Array.isArray(e))return e.map((e=>g(e))).flat();if(n(e))return Object.values(e).map((e=>g(e))).flat();if("string"==typeof e){const t=Array.from(e.matchAll(/\${(:[^}]+)}/g)).map((e=>e[1]));if(t.length>0)return g(t)}return e},f=e=>e.filter((e=>e.nodeId)).map((e=>e.nodeId)),m=e=>{const t={nodes:[],edges:[],map:{}},o=e=>{t.edges.push({data:e})},n=e=>{Object.keys(e.nodes||{}).forEach((s=>{const l=e.nodes[s],r=((e,t)=>{const o="value"in e;return{data:{id:t,color:o?i:u[a.Waiting],isStatic:o}}})(l,s);if(t.nodes.push(r),t.map[s]=r,((e,t)=>{const o=[];if("inputs"in e&&g(e.inputs).forEach((e=>{if(":"===e[0]){const{source:a,label:n}=p(e);o.push({data:{source:a,target:t,label:n}})}})),"update"in e&&e.update){const{source:a,label:n}=p(e.update);o.push({data:{source:a,target:t,isUpdate:!0,label:n}})}return o})(l,s).forEach((e=>{t.edges.push(e)})),"agent"in l&&"nestedAgent"===l.agent){const e="string"==typeof l.graph?JSON.parse(l.graph):{...l.graph},t=Object.keys(e.nodes).filter((t=>"value"in e.nodes[t])).reduce(((t,o)=>{const{source:a}=p(e.nodes[o].value);return t[a]||(t[a]=[]),t[a].push(o),t}),{});Object.keys(l.inputs).forEach((a=>{e.nodes[a]={value:"dummy"};const{source:n}=p(l.inputs[a]);o({source:s,target:a,label:n}),t[a]&&t[a].forEach((e=>{o({source:s,target:e,label:a})}))})),n(e),Object.keys(e.nodes).forEach((t=>{const a=e.nodes[t];"agent"in a&&a.isResult&&o({source:t,target:s,label:"result",isResult:!0})}))}}))};return n(e),{elements:t}},y=n=>{let r=null;const p=e(m(n.value??{nodes:{}})),g=e(),f=e(!0),y=async()=>{if(r){r.elements().remove(),r.add(p.value.elements);const e=p.value.elements.nodes.reduce(((e,t)=>t.position?"preset":e),c);console.log("layout",e),r.layout({name:e}).run(),r.fit(),e===c&&(await s(400),h())}},h=()=>{console.log("storePositions"),r&&r.nodes().forEach((e=>{const t=e.id(),o=e.position();p.value.elements.map[t].position=o}))};t(p,(()=>{console.log("updated"),y()})),t(n,(()=>{p.value=m(n.value)})),o((()=>{(()=>{try{r=l({container:g.value,style:d,layout:{name:c}}),r.on("mouseup",h),r.on("touchend",h)}catch(e){console.error(e)}})(),y()}));return t(f,(e=>{r&&r.zoomingEnabled(e)})),{cytoscapeRef:g,updateCytoscape:async(e,t)=>{[a.Completed,a.Waiting].includes(t)&&await s(100);const o=p.value.elements;o.map[e].data.color=u[t];const l=n.value,r=(l?.nodes??{})[e]??[];"agent"in r&&t===a.Queued&&(r.priority??0)>0?o.map[e].data.color="#f80":"value"in r&&t===a.Waiting&&(o.map[e].data.color=i),p.value={elements:o},t===a.Injected&&(await s(100),o.map[e].data.color=i,p.value={elements:o})},resetCytoscape:()=>{const e=p.value.elements;Object.keys(e.map).forEach((t=>{const o=n.value.nodes[t];e.map[t].data.color="value"in o?i:u[a.Waiting]})),p.value={elements:e}},layoutCytoscape:e=>{if(r){const t=r.nodes().map((e=>({id:e.id(),position:e.position()})));console.log(JSON.stringify(t)),localStorage.setItem("layoutData-"+e,JSON.stringify(t))}},loadLayout:e=>{const t=localStorage.getItem("layoutData-"+e);if(t){JSON.parse(t).forEach((e=>{if(r){const t=r.getElementById(e.id);t&&t.position(e.position)}}))}},zoomingEnabled:f}};export{f as dataSourceNodeIds,g as inputs2dataSources,y as useCytoscape};
//# sourceMappingURL=bundle.esm.min.js.map
